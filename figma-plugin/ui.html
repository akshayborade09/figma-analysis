<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>UX Analysis</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Reset & Base Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 12px;
      line-height: 1.5;
      color: #E5E5E5;
      background: #2c2c2c;
      padding: 16px;
      padding-bottom: 12px;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      height: 880px;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    /* Main Content */
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex: 1;
      overflow: hidden;
    }

    /* Section */
    .section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 500;
      color: #E5E5E5;
      line-height: 1.5;
    }

    /* URL Input Group */
    .url-input-group {
      display: flex;
      gap: 10px;
    }

    .url-input {
      flex: 1;
      height: 40px;
      background: #2c2c2c;
      border: 1px solid #525252;
      border-radius: 8px;
      padding: 12px 8px;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 12px;
      font-weight: 400;
      line-height: 1.5;
      color: #D4D4D4;
      transition: all 0.2s;
    }

    .url-input::placeholder {
      color: #737373;
    }

    .url-input:focus {
      outline: none;
      border-color: #ffffff;
      background: #2c2c2c;
      color: #ffffff;
    }

    .test-btn {
      height: 40px;
      background: #004620;
      border: none;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .test-btn:hover {
      background: #005a28;
    }

    .test-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .test-btn span {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      font-weight: 500;
      line-height: 1.5;
      color: #28a857;
    }

    .help-text {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 12px;
      font-weight: 400;
      line-height: 1.5;
      color: #A3A3A3;
    }

    /* API Key Section */
    .api-key-group {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
    }

    .provider-select {
      flex: 1;
      height: 40px;
      background: #2c2c2c;
      border: 1px solid #525252;
      border-radius: 8px;
      padding: 12px 32px 12px 8px;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 12px;
      font-weight: 400;
      color: #737373;
      cursor: pointer;
      transition: all 0.2s;
    }

    .provider-select option {
      background: #2c2c2c;
      color: #E5E5E5;
    }

    .provider-select option:first-child {
      color: #737373;
    }

    .provider-select:focus {
      outline: none;
      border-color: #ffffff;
      color: #ffffff;
    }

    .api-key-input {
      flex: 1;
      height: 40px;
      background: #2c2c2c;
      border: 1px solid #525252;
      border-radius: 8px;
      padding: 12px 8px;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 12px;
      font-weight: 400;
      color: #D4D4D4;
      transition: all 0.2s;
    }

    .api-key-input::placeholder {
      color: #737373;
    }

    .api-key-input:focus {
      outline: none;
      border-color: #ffffff;
      color: #ffffff;
    }

    .test-connection-btn {
      width: 100%;
      height: 40px;
      background: #404040;
      border: none;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: #ffffff;
    }

    .test-connection-btn:hover {
      background: #4a4a4a;
    }

    .test-connection-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .test-connection-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Divider */
    .divider {
      width: 100%;
      height: 1px;
      background: #525252;
      margin: 8px 0;
    }

    /* Frame Selection */
    .frame-display {
      height: 40px;
      background: #2c2c2c;
      border: 1px solid #525252;
      border-radius: 8px;
      padding: 12px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .frame-text {
      font-size: 12px;
      font-weight: 400;
      line-height: 1.5;
      color: #D4D4D4;
    }

    .frame-badge {
      background: #1E3A8A;
      border-radius: 4px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .frame-badge span {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      font-weight: 400;
      line-height: 1.5;
      color: #ffffff;
    }

    /* Page Info */
    .page-info {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 12px;
      font-weight: 400;
      line-height: 1.5;
      color: #A3A3A3;
    }

    /* Context Textarea */
    .context-textarea {
      width: 100%;
      min-height: 88px;
      background: #2c2c2c;
      border: 1px solid #525252;
      border-radius: 8px;
      padding: 12px 8px;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 12px;
      font-weight: 400;
      line-height: 1.5;
      color: #D4D4D4;
      resize: vertical;
      transition: all 0.2s;
    }

    .context-textarea::placeholder {
      color: #737373;
    }

    .context-textarea:focus {
      outline: none;
      border-color: #ffffff;
      background: #2c2c2c;
      color: #ffffff;
    }

    /* Radio Options */
    .radio-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .radio-option {
      background: #2c2c2c;
      border: 1px solid #525252;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .radio-option:hover {
      border-color: #737373;
    }

    .radio-option.selected {
      border-color: #ffffff;
      background: #353535;
    }

    .radio-circle {
      width: 20px;
      height: 20px;
      border: 2px solid #525252;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 2px;
      transition: all 0.2s;
    }

    .radio-option.selected .radio-circle {
      border-color: #ffffff;
      background: #ffffff;
    }

    .radio-circle-inner {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #2c2c2c;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .radio-option.selected .radio-circle-inner {
      opacity: 1;
    }

    .radio-content {
      flex: 1;
    }

    .radio-title {
      font-size: 14px;
      font-weight: 500;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .radio-description {
      font-size: 12px;
      font-weight: 400;
      color: #737373;
    }

    /* Primary Button */
    .btn-primary {
      width: 100%;
      height: 48px;
      background: #1E40AF;
      border: none;
      border-radius: 8px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      font-weight: 700;
      line-height: 1.5;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px 20px;
      margin-top: auto;
    }

    .btn-primary:hover:not(:disabled) {
      background: #1e3a8a;
      transform: translateY(-1px);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #000000;
      color: #ffffff;
      padding: 16px 20px;
      border-radius: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 12px;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .toast .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Hidden State */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Main Content -->
    <div class="main-content">
      <!-- Figma File URL Section -->
      <div class="section">
        <div class="section-title">Figma file URL (Desktop app only)</div>
        
        <input 
          type="text" 
          id="fileUrl" 
          class="url-input" 
          placeholder="Paste your figma file URL here"
        >

        <p class="help-text">Go to Share > Share with Anyone > Copy link and paste above</p>
      </div>

      <!-- API Key Section -->
      <div class="section">
        <div class="section-title">API Key</div>
        
        <div class="api-key-group">
          <select id="aiProvider" class="provider-select">
            <option value="">Select AI tool</option>
            <option value="groq">Groq</option>
            <option value="gemini">Gemini</option>
            <option value="aiml">AI/ML API</option>
            <option value="openrouter">OpenRouter</option>
            <option value="huggingface">Hugging Face</option>
            <option value="cloudflare">Cloudflare Workers</option>
            <option value="openai">OpenAI</option>
            <option value="together">Together AI</option>
            <option value="replicate">Replicate</option>
            <option value="anthropic">Claude</option>
            <option value="cohere">Cohere</option>
            <option value="mistral">Mistral AI</option>
          </select>

          <input 
            type="password" 
            id="apiKeyInput" 
            class="api-key-input" 
            placeholder="Paste your API Key here"
          >
        </div>

        <button id="testConnectionBtn" class="test-connection-btn">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3.25 12.4167L0.936887 10.1036C0.741625 9.90829 0.741624 9.59171 0.936886 9.39645L3.25 7.08333M9.25 6.08333L11.5631 3.77022C11.7584 3.57496 11.7584 3.25838 11.5631 3.06311L9.25 0.75M1.58333 9.75H11.75M0.75 3.41667H11.0833" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Test connection</span>
        </button>

        <div class="divider"></div>
      </div>

      <!-- Frame Selection Section -->
      <div class="section">
        <div class="section-title">Frame selection</div>
        
        <div class="frame-display">
          <span id="frameText" class="frame-text">No frame selected</span>
          <div class="frame-badge">
            <span id="frameCount">0</span>
          </div>
        </div>

        <div class="page-info">
          <svg width="12" height="12" viewBox="0 0 12 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M5.75 2C5.75 1.17157 6.42157 0.5 7.25 0.5H10.5C10.7761 0.5 11 0.723858 11 1V7.5C11 7.77614 10.7761 8 10.5 8H7.3885C7.04829 8 6.71481 8.08208 6.42541 8.26094C6.13602 8.4398 5.90214 8.69571 5.75 9M5.75 2C5.75 1.17157 5.07843 0.5 4.25 0.5H1C0.723858 0.5 0.5 0.723858 0.5 1V7.5C0.5 7.77614 0.723858 8 1 8H4.1115C4.45171 8 4.78519 8.08208 5.07459 8.26094C5.36398 8.4398 5.59786 8.69571 5.75 9M5.75 2V9" stroke="#A3A3A3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Figma page : <span id="pageName">Website</span></span>
        </div>
      </div>

      <!-- Context Section -->
      <div class="section">
        <div class="section-title">Context</div>
        <textarea 
          id="contextInput" 
          class="context-textarea" 
          placeholder="Give context of the analysis for filtered feedback"
        ></textarea>
      </div>

      <!-- Analysis Mode Section -->
      <div class="section">
        <div class="section-title">Select analysis mode</div>
        
        <div class="radio-options">
          <!-- Single Screen -->
          <div class="radio-option selected" data-mode="single">
            <div class="radio-circle">
              <div class="radio-circle-inner"></div>
            </div>
            <div class="radio-content">
              <div class="radio-title">Single screen</div>
              <div class="radio-description">Detailed UX analysis for one screen</div>
            </div>
          </div>

          <!-- Screen Variant -->
          <div class="radio-option" data-mode="variant">
            <div class="radio-circle">
              <div class="radio-circle-inner"></div>
            </div>
            <div class="radio-content">
              <div class="radio-title">Screen variant</div>
              <div class="radio-description">Compare multiple variants of the same screen</div>
            </div>
          </div>

          <!-- User Flow -->
          <div class="radio-option" data-mode="flow">
            <div class="radio-circle">
              <div class="radio-circle-inner"></div>
            </div>
            <div class="radio-content">
              <div class="radio-title">User flow</div>
              <div class="radio-description">Analyze user journey across multiple screens</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Analyze Button -->
    <button id="analyzeBtn" class="btn-primary" disabled>
      Analyse selected
    </button>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <div id="toastIcon"></div>
    <span id="toastText"></span>
  </div>

  <script>
    // State
    let selectedMode = 'single';
    let selectedCount = 0;
    let fileUrl = '';
    let aiProvider = '';
    let apiKey = '';

    // Elements
    const fileUrlInput = document.getElementById('fileUrl');
    const aiProviderSelect = document.getElementById('aiProvider');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    const contextInput = document.getElementById('contextInput');
    const radioOptions = document.querySelectorAll('.radio-option');
    const frameText = document.getElementById('frameText');
    const frameCount = document.getElementById('frameCount');
    const pageName = document.getElementById('pageName');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const toast = document.getElementById('toast');
    const toastIcon = document.getElementById('toastIcon');
    const toastText = document.getElementById('toastText');

    // Load saved URL and API config
    try {
      const stored = localStorage.getItem('fileUrl');
      if (stored) fileUrlInput.value = stored;
      
      const storedProvider = localStorage.getItem('aiProvider');
      if (storedProvider) {
        aiProviderSelect.value = storedProvider;
        aiProvider = storedProvider;
      }
      
      const storedKey = localStorage.getItem('apiKey');
      if (storedKey) {
        apiKeyInput.value = storedKey;
        apiKey = storedKey;
      }
    } catch (e) {
      console.log('localStorage not available');
    }

    // Save file URL on change
    fileUrlInput.addEventListener('input', () => {
      fileUrl = fileUrlInput.value.trim();
      try {
        localStorage.setItem('fileUrl', fileUrl);
      } catch (e) {
        console.log('Cannot save to localStorage');
      }
      updateAnalyzeButton();
    });

    // Handle AI Provider selection
    aiProviderSelect.addEventListener('change', () => {
      aiProvider = aiProviderSelect.value;
      try {
        localStorage.setItem('aiProvider', aiProvider);
      } catch (e) {
        console.log('Cannot save to localStorage');
      }
      updateAnalyzeButton();
    });

    // Handle API Key input
    apiKeyInput.addEventListener('input', () => {
      apiKey = apiKeyInput.value.trim();
      try {
        localStorage.setItem('apiKey', apiKey);
      } catch (e) {
        console.log('Cannot save to localStorage');
      }
      updateAnalyzeButton();
    });

    // Test Connection Button
    testConnectionBtn.addEventListener('click', () => {
      if (!fileUrl) {
        showToast('Please enter Figma file URL first', 'error');
        return;
      }
      
      if (!aiProvider) {
        showToast('Please select an AI provider', 'error');
        return;
      }
      
      if (!apiKey) {
        showToast('Please enter API key', 'error');
        return;
      }

      testConnectionBtn.disabled = true;
      showToast('Testing connection...', 'info');

      parent.postMessage({
        pluginMessage: {
          type: 'test-connection',
          config: {
            fileUrl: fileUrl,
            aiProvider: aiProvider,
            apiKey: apiKey
          }
        }
      }, '*');

      // Re-enable after 3 seconds
      setTimeout(() => {
        testConnectionBtn.disabled = false;
      }, 3000);
    });

    // Radio option selection
    radioOptions.forEach(option => {
      option.addEventListener('click', () => {
        radioOptions.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        selectedMode = option.dataset.mode;
        updateAnalyzeButton();
      });
    });

    // Analyze button
    analyzeBtn.addEventListener('click', () => {
      if (selectedCount === 0 || !fileUrl) return;

      // Validate API provider and key
      if (!aiProvider) {
        showToast('Please select an AI provider', 'error');
        return;
      }
      
      if (!apiKey) {
        showToast('Please enter API key', 'error');
        return;
      }

      analyzeBtn.disabled = true;
      showToast('Analysis in progress...', 'loading');

      parent.postMessage({
        pluginMessage: {
          type: 'analyze',
          config: {
            mode: selectedMode,
            fileUrl: fileUrl,
            context: contextInput.value.trim(),
            aiProvider: aiProvider,
            apiKey: apiKey
          }
        }
      }, '*');
    });

    // Update analyze button
    function updateAnalyzeButton() {
      const requirements = {
        single: { min: 1, max: 1 },
        variant: { min: 2, max: 10 },
        flow: { min: 3, max: 20 }
      };

      const req = requirements[selectedMode];
      const validCount = selectedCount >= req.min && selectedCount <= req.max;
      const hasUrl = fileUrl.length > 0;
      const hasProvider = aiProvider.length > 0;
      const hasKey = apiKey.length > 0;

      // Always keep the same text
      analyzeBtn.textContent = 'Analyse selected';

      // Enable/disable based on conditions
      analyzeBtn.disabled = !(validCount && hasUrl && hasProvider && hasKey);
    }

    // Update selection UI
    function updateSelectionUI(count) {
      selectedCount = count;
      
      if (count > 0) {
        frameText.textContent = `${count} frame${count > 1 ? 's' : ''} selected`;
        frameCount.textContent = count;
      } else {
        frameText.textContent = 'No frame selected';
        frameCount.textContent = '0';
      }

      updateAnalyzeButton();
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      toastText.textContent = message;
      
      if (type === 'loading') {
        toastIcon.innerHTML = '<div class="spinner"></div>';
      } else if (type === 'success') {
        toastIcon.innerHTML = `
          <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <polyline points="3 8 6 11 13 4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
          </svg>
        `;
      } else if (type === 'error') {
        toastIcon.innerHTML = `
          <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="4" y1="4" x2="12" y2="12" stroke="white" stroke-width="2" stroke-linecap="round"></line>
            <line x1="12" y1="4" x2="4" y2="12" stroke="white" stroke-width="2" stroke-linecap="round"></line>
          </svg>
        `;
      } else {
        toastIcon.innerHTML = '';
      }

      toast.classList.add('show');

      if (type !== 'loading') {
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }
    }

    // Hide toast
    function hideToast() {
      toast.classList.remove('show');
    }

    // Handle messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      switch (msg.type) {
        case 'selection-update':
          updateSelectionUI(msg.count);
          break;

        case 'connection-success':
          testBtn.disabled = false;
          hideToast();
          showToast('Connection successful!', 'success');
          break;

        case 'connection-error':
          testBtn.disabled = false;
          hideToast();
          showToast('Connection failed', 'error');
          break;

        case 'success':
          analyzeBtn.disabled = false;
          hideToast();
          showToast('Analysis complete! Check Figma comments.', 'success');
          break;

        case 'error':
          analyzeBtn.disabled = false;
          hideToast();
          showToast(msg.message || 'Analysis failed', 'error');
          break;
      }
    };
  </script>
</body>
</html>
